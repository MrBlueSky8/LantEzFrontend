<!-- HEADER -->
<div class="mi-empresa-header">DASHBOARD • REPORTE GENERAL</div>

<!-- FILTROS SUPERIORES -->
<div class="dash-filtros">
  <div class="filtro-grupo">
    <label>Desde</label>
    <input
      type="date"
      [(ngModel)]="fInicio"
      (change)="onDateRangeChange()"
      class="inp-fecha"
    />
  </div>

  <div class="filtro-grupo">
    <label>Hasta</label>
    <input
      type="date"
      [(ngModel)]="fFin"
      (change)="onDateRangeChange()"
      class="inp-fecha"
    />
  </div>

  <div class="filtro-grupo">
    <label>Estado (tabla)</label>
    <select
      [(ngModel)]="estado"
      (change)="onEstadoChange(estado || '')"
      class="inp-select"
    >
      <option [ngValue]="undefined">Todos</option>
      <option value="pendiente">Pendiente</option>
      <option value="aceptado">Aceptado</option>
      <option value="rechazado">Rechazado</option>
    </select>
  </div>

  <div class="filtro-grupo">
    <label>Top evaluadores</label>
    <input
      type="number"
      min="1"
      [(ngModel)]="topN"
      (change)="onTopNChange(topN)"
      class="inp-num"
    />
  </div>

  <button class="btn-aplicar" (click)="loadDashboard()">
    Aplicar filtros
  </button>

  <select
    class="combo-empresa"
    [(ngModel)]="empresaSeleccionadaId"
    (change)="onEmpresaSeleccionadaChange()"
    class="inp-select"
    [ngClass]="{ 'placeholder': !empresaSeleccionadaId }"
  >
    <option [ngValue]="null" disabled>Selecciona Empresa</option>
    <option *ngFor="let empresa of empresas" [ngValue]="empresa.id">{{ empresa.nombre }}</option>
  </select>
</div>

<!-- ESTADO DE CARGA / ERROR -->
<div class="dash-status" *ngIf="loading">Cargando datos…</div>
<div class="dash-error" *ngIf="!loading && errorMsg">{{ errorMsg }}</div>

<!-- KPI CARDS -->
<div class="seccion-indicadores" *ngIf="!loading">
  <div class="card-indicador kpi">
    <span class="indicador-label">Evaluaciones activas</span>
    <span class="indicador-numero">{{ kpiActivas }}</span>
    <span class="indicador-detalle">En estado pendiente</span>
  </div>

  <div class="card-indicador kpi">
    <span class="indicador-label">Evaluaciones finalizadas</span>
    <span class="indicador-numero">{{ kpiFinalizadas }}</span>
    <span class="indicador-detalle">Aceptadas + Rechazadas</span>
  </div>

  <div class="card-indicador kpi">
    <span class="indicador-label">Postulantes en proceso</span>
    <span class="indicador-numero">{{ kpiPostulantesProceso }}</span>
    <span class="indicador-detalle">Únicos con estado pendiente</span>
  </div>

  <div class="card-indicador kpi">
    <span class="indicador-label">Evaluadores activos</span>
    <span class="indicador-numero">{{ kpiEvaluadoresActivos }}</span>
    <span class="indicador-detalle">Con asignaciones en el rango</span>
  </div>
</div>

<!-- BLOQUES COLAPSABLES (evita sobresaturar) -->
<!-- GRAFICOS -->
<details class="dash-block" open>
  <summary>Gráficos de desempeño</summary>

  <div class="dash-graficos">
    <!-- Doughnut: Evaluaciones por estado -->
    <div class="grafico-card">
      <div class="grafico-titulo">Evaluaciones por estado</div>
      <div class="grafico-canvas">
        <canvas
          baseChart
          [data]="doughnutEstadosData"
          [options]="doughnutEstadosOptions"
          type="doughnut">
        </canvas>
      </div>
    </div>

    <!-- Barras: Postulantes por compatibilidad -->
    <div class="grafico-card">
      <div class="grafico-titulo">Postulantes por resultado</div>
      <div class="grafico-canvas">
        <canvas
          baseChart
          [data]="barCompatData"
          [options]="barCompatOptions"
          type="bar">
        </canvas>
      </div>
    </div>

    <!-- Barras horizontales: Carga de evaluadores -->
    <div class="grafico-card span-2">
      <div class="grafico-titulo">Carga de evaluadores (Top {{ topN }})</div>
      <div class="grafico-canvas">
        <canvas
          baseChart
          [data]="barCargaEvalData"
          [options]="barCargaEvalOptions"
          type="bar">
        </canvas>
      </div>
    </div>
  </div>
</details>

<!-- TABLA RESUMEN -->
<details class="dash-block" open>
  <summary>Tabla de postulaciones</summary>

  <div class="tabla-toolbar">
    <div class="tabla-meta">
      <span *ngIf="loadingTabla">Cargando…</span>
      <span *ngIf="!loadingTabla">Total: {{ tablaResumen.length }}</span>
    </div>
    <button class="btn-refrescar" (click)="loadTablaResumen()">
      Refrescar
    </button>
  </div>

  <div class="tabla-resumen">
    <div class="tabla-header">
      <div>ID</div>
      <div>Fecha</div>
      <div>Empresa</div>
      <div>Puesto</div>
      <div>Evaluador</div>
      <div>Postulante</div>
      <div>Estado</div>
      <div>Compat.</div>
      <!-- <div>Aprobado</div> -->
      <!-- <div>Ocultar</div> -->
    </div>

    <div class="tabla-row"
         *ngFor="let r of tablaPaginada; trackBy: trackByIdx">
      <div>{{ r.postulacionId }}</div>
      <div>{{ r.fechaPostulacion | date:'short' }}</div>
      <div>{{ r.empresaNombre }}</div>
      <div>{{ r.puestoNombre }}</div>
      <div>{{ r.evaluadorNombre }}</div>
      <div>{{ r.postulanteNombre }}</div>
      <div class="estado-tag"
           [ngClass]="{
             'estado-pendiente': r.estadoPostulacion==='pendiente',
             'estado-aceptado':  r.estadoPostulacion==='aceptado',
             'estado-rechazado': r.estadoPostulacion==='rechazado'
           }">
        {{ r.estadoPostulacion | titlecase }}
      </div>
      <div>{{ r.porcentajeCompatibilidad != null ? r.porcentajeCompatibilidad : '—' }}%</div>
      <!-- <div>{{ r.aprobado ? 'Sí' : 'No' }}</div> -->
      <!-- <div>{{ r.ocultar ? 'Sí' : 'No' }}</div> -->
    </div>

    <div class="tabla-empty" *ngIf="!loadingTabla && tablaResumen.length === 0">
      No hay registros para el rango seleccionado.
    </div>
  </div>

  <!-- Paginador -->
  <mat-paginator
    [length]="tablaResumen.length"
    [pageSize]="pageSize"
    [pageSizeOptions]="[5, 10, 15]"
    [pageIndex]="pageIndex"
    (page)="onPageTablaChange($event)">
  </mat-paginator>
</details>
